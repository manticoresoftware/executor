#!/usr/bin/env bash
# Copyright (c) 2022, Manticore Software LTD (https://manticoresearch.com)

# This program is free software; you can redistribute it and/or modify
# it under the terms of the The PHP License, version 3.01. You should have
# received a copy of the license along with this program; if you did not, 
# you can find it at https://www.php.net/license/3_01.txt

# That file here is for reference; actually used the one stored on the host to avoid checkout of the whole code
set -e
copy_to() {
  echo -e "Copy $1 to /mnt/repo_storage/manticoresearch_$2";
  cp "$1" "/mnt/repo_storage/manticoresearch_$2" && echo -e "Success"
  echo
}

get_destination() {
  if [ -z "${IS_RELEASE_DIGIT}" ]; then
    IS_RELEASE_DIGIT="$(echo "$f" | cut -d. -f3 | cut -d- -f1)"
    if [[ $((IS_RELEASE_DIGIT % 2)) -eq 0 ]]; then
      DESTINATION="release"
    else
      DESTINATION="dev"
    fi
  fi
}

echo "Collected archives"
ls -1 build/

for f in build/*.zip build/*.exe; do
  if [ -f "$f" ]; then
    get_destination
    copy_to "$f" windows/$DESTINATION/x64/
  fi
done

for f in build/*.gz; do
  if [ -f "$f" ]; then
    get_destination
    copy_to "$f" macos/$DESTINATION/
  fi
done

rm -rf build/*.zip
rm -rf build/*.exe
rm -rf build/*.gz
