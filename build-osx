#!/usr/bin/env bash
# Copyright (c) 2022, Manticore Software LTD (https://manticoresearch.com)

# This program is free software; you can redistribute it and/or modify
# it under the terms of the The PHP License, version 3.01. You should have
# received a copy of the license along with this program; if you did not, 
# you can find it at https://www.php.net/license/3_01.txt

set -e
PHP_VERSION="$1"
ZSTD_REV="4504e4186e79b197cfcb75d4d09aa47ef7d92fe9"
SKIP_SYSTEM_DEPS="$2"

# sudo xcode-select --install
# We introduce this parameter to make it easier to reuse the code
# and build it for homebrew with same script
if [[ -z "$SKIP_SYSTEM_DEPS" ]]; then
  brew upgrade
  brew install curl autoconf automake bison re2c zstd
fi

# Leave only static libs on
if which brew; then
  ZSTD_PATH=$(brew --prefix zstd)
  if test -f "$ZSTD_PATH"/lib/*.dylib; then
    for f in "$ZSTD_PATH"/lib/*.dylib; do
      mv "$f" "$f.bak"
    done
  fi
fi

curl -sSL "https://github.com/php/php-src/archive/refs/tags/php-$PHP_VERSION.tar.gz" | tar -xzf -
cd "php-src-php-$PHP_VERSION"

# Build extra extensions
cd ext

#  zstd
git clone --recursive --depth=1 https://github.com/kjdev/php-ext-zstd.git
mv php-ext-zstd zstd
cd zstd && git checkout "$ZSTD_REV"
# cd zstd && make && cd ..
cd ..

cd ..

# Build main php
mkdir dist
prefix="$(pwd)/dist"
./buildconf --force
./configure YACC=/usr/local/Cellar/bison/3.8.2/bin/bison \
  CFLAGS="-O3" --prefix="$prefix" --disable-all \
  --enable-shared=no --enable-static=yes --with-layout=GNU \
  --with-pear=no --disable-cgi --disable-phpdbg \
  --with-pcre-jit --enable-zstd --with-libzstd  \
  --enable-pcntl --enable-posix \
  --enable-socket
make LDFLAGS=-ldl -j8
make install-cli
strip dist/bin/php

# Return skipped dynamic libs
if test -f "$ZSTD_PATH"/lib/*.dylib.bak; then
  for f in "$ZSTD_PATH"/lib/*.dylib.bak; do
    mv "$f" "${f%*.bak}"
  done
fi
